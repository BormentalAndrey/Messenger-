name: Unpack Termux Archive

on:
  push:
    branches:
      - main  # или ваша основная ветка
  workflow_dispatch:  # для ручного запуска

jobs:
  unpack-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # важно для последующего пуша

      - name: Setup Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install unzip
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Check if archive exists
        run: |
          cd app/src/main/kotlin/com/kakdela/p2p/ui/terminal
          if [ -f termux-app-master.zip ]; then
            echo "Архив найден"
            ls -la
          else
            echo "Ошибка: архив termux-app-master.zip не найден!"
            exit 1
          fi

      - name: List directory before unpack
        run: |
          cd app/src/main/kotlin/com/kakdela/p2p/ui/terminal
          echo "Содержимое директории до распаковки:"
          ls -la

      - name: Unpack archive
        run: |
          cd app/src/main/kotlin/com/kakdela/p2p/ui/terminal
          unzip -o termux-app-master.zip

          # Если внутри архива есть папка termux-app-master, перемещаем содержимое наверх
          if [ -d termux-app-master ]; then
            mv termux-app-master/* . 2>/dev/null || true
            mv termux-app-master/.* . 2>/dev/null || true
            rmdir termux-app-master || true
          fi

          # Опционально: удаляем сам архив после распаковки
          rm termux-app-master.zip

      - name: List directory after unpack
        run: |
          cd app/src/main/kotlin/com/kakdela/p2p/ui/terminal
          echo "Содержимое директории после распаковки:"
          ls -la

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: unpack termux-app-master archive"
          branch: main  # или ваша ветка
          file_pattern: app/src/main/kotlin/com/kakdela/p2p/ui/terminal/*
