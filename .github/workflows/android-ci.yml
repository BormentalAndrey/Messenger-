name: Android CI - Unpack Termux

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  unpack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Принудительно передаем встроенный токен
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Unpack termux-app
        run: |
          # Настройки путей
          SRC_ZIP="termux-library/termux-app-master.zip"
          DEST_DIR="termux-library/termux-app"
          
          # Проверяем, существует ли файл перед работой
          if [[ ! -f "$SRC_ZIP" ]]; then
            echo "::error::Архив $SRC_ZIP не найден! Проверьте, загружен ли он в репозиторий."
            exit 1
          fi

          # Создаем папку назначения
          mkdir -p "$DEST_DIR"

          # Распаковка во временную директорию
          mkdir -p tmp_unzip
          unzip -q "$SRC_ZIP" -d tmp_unzip
          
          # Перемещаем всё, включая скрытые файлы (.gradle, .gitignore)
          # Используем вложенную папку из архива (termux-app-master)
          if [ -d "tmp_unzip/termux-app-master" ]; then
            shopt -s dotglob
            mv tmp_unzip/termux-app-master/* "$DEST_DIR/"
            echo "✅ Распаковка в $DEST_DIR завершена"
          else
            echo "::error::Структура архива не соответствует ожидаемой (нет папки termux-app-master)"
            exit 1
          fi

          # Очистка
          rm -rf tmp_unzip

      - name: Upload unpacked artifact
        uses: actions/upload-artifact@v4
        with:
          name: termux-app-unpacked
          path: termux-library/termux-app
          retention-days: 1
          
