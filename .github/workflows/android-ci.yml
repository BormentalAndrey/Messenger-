name: Android CI - Unpack Termux

on:
  workflow_dispatch:

jobs:
  unpack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Extract and Move to Termux-library
        run: |
          # 1. Пути
          ZIP_FILE="termux-library/termux-app-master.zip"
          TARGET_DIR="Termux-library"
          TMP_DIR="tmp_extraction"

          # Проверка на вшивость
          if [ ! -f "$ZIP_FILE" ]; then
            echo "::error::Файл $ZIP_FILE не найден!"
            exit 1
          fi

          # 2. Подготовка папок
          mkdir -p "$TARGET_DIR"
          mkdir -p "$TMP_DIR"

          # 3. Распаковка
          unzip -q "$ZIP_FILE" -d "$TMP_DIR"

          # 4. УМНОЕ ПЕРЕМЕЩЕНИЕ
          # Ищем первую подпапку внутри распакованного архива (например, termux-app-master)
          # и перемещаем её содержимое в Termux-library
          INNER_FOLDER=$(find "$TMP_DIR" -mindepth 1 -maxdepth 1 -type d | head -n 1)

          if [ -n "$INNER_FOLDER" ]; then
            echo "Найдена папка внутри архива: $INNER_FOLDER"
            shopt -s dotglob
            mv "$INNER_FOLDER"/* "$TARGET_DIR/"
            echo "✅ Файлы успешно извлечены в $TARGET_DIR"
          else
            echo "::warning::Вложенных папок не найдено, пробуем корень архива..."
            shopt -s dotglob
            mv "$TMP_DIR"/* "$TARGET_DIR/"
          fi

          # 5. Очистка
          rm -rf "$TMP_DIR"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: termux-ready
          path: Termux-library/
          
