name: Android CI - Unpack Termux

on:
  workflow_dispatch:

# Явно разрешаем чтение содержимого репозитория
permissions:
  contents: read

jobs:
  unpack:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Передаем токен для авторизации
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Unpack termux-app
        run: |
          # Константы
          ZIP_FILE="termux-library/termux-app-master.zip"
          TARGET_DIR="termux-library/termux-app"
          TMP_DIR="tmp_extraction"

          # Проверка на существование файла
          if [ ! -f "$ZIP_FILE" ]; then
            echo "::error file=$ZIP_FILE::Архив не найден по указанному пути!"
            exit 1
          fi

          # Создаем чистую целевую папку
          mkdir -p "$TARGET_DIR"

          # Распаковка во временную папку
          unzip -q "$ZIP_FILE" -d "$TMP_DIR"

          # Перемещаем содержимое вложенной папки 'termux-app-master' в 'termux-library/termux-app'
          # shopt -s dotglob позволяет перемещать скрытые файлы (.gitignore, .gradle и т.д.)
          shopt -s dotglob
          if [ -d "$TMP_DIR/termux-app-master" ]; then
            mv "$TMP_DIR/termux-app-master/"* "$TARGET_DIR/"
            echo "✅ Файлы успешно перемещены в $TARGET_DIR"
          else
            echo "::error::Внутри архива не найдена папка termux-app-master!"
            exit 1
          fi

          # Удаляем временный мусор
          rm -rf "$TMP_DIR"

      - name: Upload unpacked artifact
        uses: actions/upload-artifact@v4
        with:
          name: termux-app-source
          path: termux-library/termux-app/
          retention-days: 1
          
